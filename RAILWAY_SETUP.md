# Railway Deployment Setup Guide

Your Caly Voice Agent is now configured to work with Railway's environment variables. This guide walks through deploying to Railway.

## What Was Changed

### 1. **Database Connection (db/postgres.js)**
- ✅ Now reads `DATABASE_URL` from Railway's PostgreSQL plugin
- ✅ Falls back to individual `DB_HOST`, `DB_PORT`, etc. for local development
- ✅ Automatically enables SSL in production

### 2. **Webhook Base URL (routes/exotel.js)**
- ✅ Automatically detects `RAILWAY_PUBLIC_DOMAIN` and uses it
- ✅ Falls back to `EXOTEL_WEBHOOK_BASE_URL` if set
- ✅ Defaults to `http://localhost:3000` for local dev

### 3. **Logging (utils/logger.js)**
- ✅ Console output enabled everywhere
- ✅ File logging only in development (Railway doesn't persist files)
- ✅ All logs go to stdout/stderr for Railway monitoring

### 4. **Port & Host (server.js)**
- ✅ Already using environment variables correctly
- ✅ Railway assigns port automatically to `process.env.PORT`

---

## Railway Deployment Steps

### Step 1: Create Railway Project

1. Go to [Railway.app](https://railway.app)
2. Click "New Project"
3. Select "Deploy from GitHub" (or use CLI)
4. Connect your repository

### Step 2: Add PostgreSQL Plugin

1. In Railway dashboard, click "Add Service"
2. Select "PostgreSQL"
3. Railway automatically creates `DATABASE_URL` ✅

### Step 3: Configure Environment Variables

In Railway dashboard, add these variables to your project:

#### Exotel Configuration
```
EXOTEL_API_KEY=5f6b48d2f2db5e8411ca236e8be4482bb61afce15976e3b2
EXOTEL_API_TOKEN=fbccb678186edb95082db25cae4bd4002789807d2a615c83
EXOTEL_SID=caly61
EXOTEL_APP_ID=Caly
EXOTEL_PHONE_NUMBER=+919513886363
```

#### OpenAI Configuration
```
OPENAI_API_KEY=sk-proj-...
OPENAI_REALTIME_MODEL=gpt-4o-realtime-preview
OPENAI_TTS_VOICE=alloy
```

#### ASR Configuration (Choose one)
```
ASR_PROVIDER=deepgram
DEEPGRAM_API_KEY=bae733f9fe6b93bb...
# OR
ASR_PROVIDER=whisper
WHISPER_API_KEY=sk-proj-...
```

#### Shopify Configuration (if needed)
```
SHOPIFY_STORE_URL=your-store.myshopify.com
SHOPIFY_API_KEY=...
SHOPIFY_API_SECRET=...
SHOPIFY_ACCESS_TOKEN=...
SHOPIFY_API_VERSION=2025-01
```

#### Shiprocket Configuration (if needed)
```
SHIPROCKET_EMAIL=your_email@example.com
SHIPROCKET_PASSWORD=...
SHIPROCKET_API_URL=https://apiv2.shiprocket.in/v1/external
```

#### WhatsApp Configuration (if needed)
```
WHATSAPP_BUSINESS_ID=...
WHATSAPP_ACCESS_TOKEN=...
WHATSAPP_PHONE_NUMBER_ID=...
```

#### Wasabi S3 Configuration
```
WASABI_ENDPOINT=https://s3.wasabisys.com
WASABI_REGION=ap-southeast-1
WASABI_ACCESS_KEY=QLAAUYRMLG4CU4WDKPCZ
WASABI_SECRET_KEY=mdEMzdULHPXit2beAAEWDBsgGz6y8pugZQDeeMW5
WASABI_BUCKET=caly-recordings
```

#### Monitoring & Alerts
```
SLACK_WEBHOOK_URL=your_slack_webhook_url
ALERT_EMAIL=alerts@yourcompany.com
LOG_LEVEL=info
```

#### Security
```
JWT_SECRET=91978bc288ab08fb1c61369e1f81e87946cb46eb
ENCRYPTION_KEY=83cN$2C$XGV=VkQvPjRJB/5*1F=XuREfwBe5vpLU^OkNDI2PmdKn6rmR&pj55awwTSS&vfOR4XJknKLBTHxlRSH9HPP1TQ9Z$hcL/qDa@SPxwY^MdDV$j2pI&LPIsDWq
```

#### Application Settings
```
NODE_ENV=production
HOST=0.0.0.0
PORT=3000 (optional - Railway handles this)
POLICY_REFUND_AUTO_THRESHOLD=2000
POLICY_RETURN_WINDOW_DAYS=14
POLICY_CANCEL_WINDOW_HOURS=24
POLICY_RETENTION_DAYS=45
```

### Step 4: Connect to Exotel

Your webhook URLs will be:

**Automatically Generated by Railway:**
```
https://<RAILWAY_PUBLIC_DOMAIN>/webhooks/exotel/call-start
https://<RAILWAY_PUBLIC_DOMAIN>/webhooks/exotel/call-end
https://<RAILWAY_PUBLIC_DOMAIN>/webhooks/exotel/recording
```

Configure these in Exotel dashboard:
1. Go to Exotel Settings → Webhooks
2. Set the Call Start URL to: `https://<your-railway-domain>/webhooks/exotel/call-start`
3. Set the Call End URL to: `https://<your-railway-domain>/webhooks/exotel/call-end`
4. Set the Recording URL to: `https://<your-railway-domain>/webhooks/exotel/recording`

**Replace `<your-railway-domain>` with your actual Railway public domain** (visible in Railway dashboard under Deployments → Domains)

### Step 5: Deploy

1. Push code to GitHub
2. Railway automatically deploys on push
3. Check Railway logs for deployment status
4. Verify `/health` endpoint: `https://<your-domain>/health`

---

## Environment Variables Reference

### Auto-Provided by Railway

| Variable | Source | Usage |
|----------|--------|-------|
| `DATABASE_URL` | PostgreSQL Plugin | DB Connection |
| `PORT` | Railway | Server Port |
| `RAILWAY_PUBLIC_DOMAIN` | Railway | Webhook URLs |
| `RAILWAY_ENVIRONMENT_ID` | Railway | Env Detection |
| `RAILWAY_DEPLOYMENT_ID` | Railway | Deployment ID |

### Must Set in Railway Dashboard

All other variables from `.env` (Exotel, OpenAI, S3, etc.)

### Not Needed in Railway

- `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASSWORD` (use `DATABASE_URL` instead)
- `REDIS_HOST`, `REDIS_PORT` (if using Redis plugin, it provides `REDIS_URL`)
- `EXOTEL_WEBHOOK_BASE_URL` (auto-detected from `RAILWAY_PUBLIC_DOMAIN`)

---

## Local Development

Your local `.env` file still works as before:
```
NODE_ENV=development
PORT=3000
HOST=0.0.0.0
DB_HOST=localhost
DB_PORT=5432
DB_NAME=caly_db
DB_USER=postgres
DB_PASSWORD=your_password
REDIS_URL=redis://localhost:6379
EXOTEL_WEBHOOK_BASE_URL=https://yourdomain.com
... (all other keys)
```

Run locally with:
```bash
npm install
npm run dev
```

---

## Troubleshooting

### Database Connection Failed
- ✅ Verify PostgreSQL plugin is added to Railway project
- ✅ Check `DATABASE_URL` is set in Railway dashboard
- ✅ Review Railway logs for connection errors

### Webhook URLs Not Working
- ✅ Verify `RAILWAY_PUBLIC_DOMAIN` is visible in Railway dashboard
- ✅ Check Exotel settings are updated with correct domain
- ✅ Ensure `NODE_ENV=production` in Railway

### Logs Not Appearing
- ✅ Check Railway Logs tab (all output goes there)
- ✅ File logging is disabled on Railway (use Railway logging UI)

### Local Dev Still Works?
- ✅ `.env` file is only read locally
- ✅ Railway ignores `.env` and uses dashboard variables
- ✅ Switch between local and Railway by changing environment

---

## Next Steps

1. ✅ Add PostgreSQL plugin in Railway
2. ✅ Configure all environment variables in Railway dashboard
3. ✅ Connect Exotel webhooks to Railway domain
4. ✅ Deploy and test `/health` endpoint
5. ✅ Monitor logs in Railway dashboard
6. ✅ Set up error alerts in Slack (optional)

---

## Questions?

If you need help:
1. Check Railway logs for detailed error messages
2. Verify all required variables are set in Railway dashboard
3. Test locally with `npm run dev` first
4. Ensure Exotel webhooks point to correct domain
